name: Build
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.version.outputs.version }}
      pkgversion: ${{ steps.version.outputs.pkgversion }}
    steps:
      - name: checkout repository
        uses: actions/checkout@v4

      - name: check raylib version
        id: version
        shell: bash
        run: |
          echo "version=$(sed -n 's/.*<TargetRaylibTag>\(.*\)<\/TargetRaylibTag>.*/\1/p' Raylib-cs/Build.props)">> ${GITHUB_OUTPUT}
          echo "pkgversion=$(sed -n 's/.*<PackageVersion>\(.*\)<\/PackageVersion>.*/\1/p' Raylib-cs/Build.props)">> ${GITHUB_OUTPUT}

  build-linux:
    runs-on: ${{ matrix.runner }}
    needs: build
    continue-on-error: ${{ matrix.continue-on-error }}
    strategy:
      matrix:
        name: [x64, arm64]
        include:
          - name: x64
            arch: x86_64
            runner: ubuntu-22.04
            continue-on-error: false
          - name: arm64
            arch: aarch64
            runner: ubuntu-24.04-arm
            continue-on-error: true
    steps:
      - name: checkout repository
        uses: actions/checkout@v4

      - name: setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            6.0.x
            8.0.x

      - name: setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install \
            libasound2-dev \
            libx11-dev \
            libxrandr-dev \
            libxi-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libxcursor-dev \
            libxinerama-dev

      - name: build projects
        run: dotnet build -c Release

      - name: run tests
        run: dotnet test Raylib-cs.Tests -c Release

      - name: upload build
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.name }}
          path: Raylib-cs.Native/bin/Release/native/raylib/libraylib.so
          if-no-files-found: error

  build-osx:
    runs-on: macos-latest
    needs: build
    strategy:
      matrix:
        name: [arm64, x64]
        include:
          - name: arm64
            arch: arm64
          - name: x64
            arch: x86_64
    steps:
      - name: checkout repository
        uses: actions/checkout@v4

      - name: setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            6.0.x
            8.0.x

      - name: build projects
        run: dotnet build -c Release /p:BuildArch=${{ matrix.arch }}

      - name: run tests
        run: dotnet test Raylib-cs.Tests -c Release

      - name: upload build
        uses: actions/upload-artifact@v4
        with:
          name: osx-${{ matrix.name }}
          path: Raylib-cs.Native/bin/Release/native/raylib/libraylib.dylib
          if-no-files-found: error

  build-windows:
    runs-on: windows-latest
    needs: build
    continue-on-error: ${{ matrix.continue-on-error }}
    strategy:
      matrix:
        name: [x86, x64, arm64]
        include:
          - name: x86
            arch: win32
            continue-on-error: false
          - name: x64
            arch: x64
            continue-on-error: false
          - name: arm64
            arch: arm64
            continue-on-error: true
    steps:
      - name: checkout repository
        uses: actions/checkout@v4

      - name: setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            6.0.x
            8.0.x

      - name: build projects
        run: dotnet build -c Release /p:BuildArch=${{ matrix.arch }}

      - name: run tests
        run: dotnet test Raylib-cs.Tests -c Release

      - name: upload build
        uses: actions/upload-artifact@v4
        with:
          name: win-${{ matrix.name }}
          path: Raylib-cs.Native/bin/Release/native/raylib/Release/raylib.dll
          if-no-files-found: error

  build-publish:
    runs-on: ubuntu-22.04
    needs:
      - build-linux
      - build-osx
      - build-windows
    steps:
      - name: checkout repository
        uses: actions/checkout@v4

      - uses: actions/download-artifact@v4.1.7
        with:
          name: linux-x64
          path: Raylib-cs/runtimes/linux-x64/native

      - uses: actions/download-artifact@v4.1.7
        with:
          name: linux-arm64
          path: Raylib-cs/runtimes/linux-arm64/native
        continue-on-error: true

      - uses: actions/download-artifact@v4.1.7
        with:
          name: osx-arm64
          path: Raylib-cs/runtimes/osx-arm64/native

      - uses: actions/download-artifact@v4.1.7
        with:
          name: osx-x64
          path: Raylib-cs/runtimes/osx-x64/native

      - uses: actions/download-artifact@v4.1.7
        with:
          name: win-x86
          path: Raylib-cs/runtimes/win-x86/native

      - uses: actions/download-artifact@v4.1.7
        with:
          name: win-x64
          path: Raylib-cs/runtimes/win-x64/native

      - uses: actions/download-artifact@v4.1.7
        with:
          name: win-arm64
          path: Raylib-cs/runtimes/win-arm64/native
        continue-on-error: true

      - name: setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            6.0.x
            8.0.x

      - name: create NuGet Package
        run: dotnet pack Raylib-cs -c Release --output nuget

      - name: organize runtimes folder structure
        shell: bash
        run: |
          mkdir -p runtimes/Windows-x64
          mkdir -p runtimes/Windows-x86
          mkdir -p runtimes/Windows-arm64
          mkdir -p runtimes/osx-x64
          mkdir -p runtimes/osx-arm64
          mkdir -p runtimes/Linux-x64
          mkdir -p runtimes/Linux-arm64
          
          # Copy Windows binaries
          if [ -f "Raylib-cs/runtimes/win-x64/native/raylib.dll" ]; then
            cp Raylib-cs/runtimes/win-x64/native/raylib.dll runtimes/Windows-x64/
          fi
          if [ -f "Raylib-cs/runtimes/win-x86/native/raylib.dll" ]; then
            cp Raylib-cs/runtimes/win-x86/native/raylib.dll runtimes/Windows-x86/
          fi
          if [ -f "Raylib-cs/runtimes/win-arm64/native/raylib.dll" ]; then
            cp Raylib-cs/runtimes/win-arm64/native/raylib.dll runtimes/Windows-arm64/
          fi
          
          # Copy macOS binaries
          if [ -f "Raylib-cs/runtimes/osx-x64/native/libraylib.dylib" ]; then
            cp Raylib-cs/runtimes/osx-x64/native/libraylib.dylib runtimes/osx-x64/
          fi
          if [ -f "Raylib-cs/runtimes/osx-arm64/native/libraylib.dylib" ]; then
            cp Raylib-cs/runtimes/osx-arm64/native/libraylib.dylib runtimes/osx-arm64/
          fi
          
          # Copy Linux binaries
          if [ -f "Raylib-cs/runtimes/linux-x64/native/libraylib.so" ]; then
            cp Raylib-cs/runtimes/linux-x64/native/libraylib.so runtimes/Linux-x64/
          fi
          if [ -f "Raylib-cs/runtimes/linux-arm64/native/libraylib.so" ]; then
            cp Raylib-cs/runtimes/linux-arm64/native/libraylib.so runtimes/Linux-arm64/
          fi
          
          # Display the structure
          echo "Runtimes folder structure:"
          ls -R runtimes/

      - name: upload runtimes artifact
        uses: actions/upload-artifact@v4
        with:
          name: runtimes
          path: runtimes/

      - name: upload NuGet Package As Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: nuget/*
